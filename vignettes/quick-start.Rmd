---
title: "Quick Start"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Setup 

```{r setup}
library(googleAuthR)
library(googleCloudAutoMLTablesR)

# options for debugging to see auth and details on functions later 
# options(gargle_quiet = FALSE)
# options(googleAuthR.verbose = 0)

options(googleAuthR.scopes.selected = "https://www.googleapis.com/auth/cloud-platform")

gar_auth_service(json_file = Sys.getenv("GAR_SERVICE_JSON"))

# functions for debugging auth issues 
# googleAuthR::gar_token_info(2)
# googleAuthR::gar_check_existing_token()
# gargle::gargle_oauth_sitrep()
```

Test authentication and check in correct project: 

```{r}
# assumes you have projectId string set to environment 
# argument GCAT_PROJECT_ID
projectId <- Sys.getenv("GCAT_PROJECT_ID")

## Get list of locations 
locations_list <- gcat_list_locations(projectId = projectId)
locations_list
```

## Set location 

```{r}
location <- "us-central1"
location_path <- gcat_get_location(projectId = projectId,
                                   locationId = location)
location_path
```

## Get list of datasets 

```{r}
datasets_list <- gcat_list_datasets(projectId = projectId,
                                    locationId = location)
datasets_list
```

### Optional - setting and getting global dataset name

To simplify code for other API calls, you can set a dataset name to a global environment variable:

```{r}
gcat_global_dataset("test_01_bq")
```

```{r}
gcat_get_global_dataset()
```

# Importing data into AutoML Tables 

## Options and Workflow

There are 2 options for loading data into AutoML Tables

1. Google Cloud Storage 
2. BigQuery

At a high-level, the workflow is:

1. Locate your data in GCP (csv file in GCS bucket or csv file loaded into a BQ table)
1. Create AutoML Tables dataset
2. Import data from GCS or BQ into AutoML Tables dataset 

## From Google Cloud Storage

To load data into AutoML Tables from Google Cloud storage, first do the following:

1. Setup a GCS bucket that is [regional](https://cloud.google.com/automl-tables/docs/prepare#bucket_requirements) and in `us-central1` region
2. Upload your data file manually or via `googleCloudStorageR`

Now we are ready to create an AutoML tables dataset.

### Create AutoML Tables dataset 

For now, one has to manually create dataset via [GCP console](https://console.cloud.google.com/automl-tables/datasets/) 

```{r}
# TODO @justinjm - fix function, issue #1 
# https://github.com/justinjm/googleCloudAutoMLTablesR/issues/1
# gcat_dataset <- gcat_create_dataset(projectId = projectId,
#                                     locationId = location,
#                                     displayName = "bank_marketing")
```

### Import data 

Execute import from Google Cloud storage: 

```{r}
# set url as seperate parameter to keep line length under 80
# gs_url <- "gs://amlt-test/bank_marketing.csv"
# 
# gcat_import_data(projectId = projectId,
#                  location = location,
#                  dataset_display_name = "bank_marketing",
#                  input_source = "gcs",
#                  input_url = gs_url)
```

## From BigQuery 

To load data into AutoML Tables from BigQuery, first do the following:

1. Setup a BQ dataset 
2. Upload your data file manually or via `bigQueryR` or `bigrquery`

### Create AutoML Tables dataset 

For now, one has to manually create dataset via [GCP console](https://console.cloud.google.com/automl-tables/datasets/) 

```{r}
# TODO @justinjm - fix function, issue #1 
# https://github.com/justinjm/googleCloudAutoMLTablesR/issues/1  
# gcat_dataset <- gcat_create_dataset(projectId = projectId,
#                                     location = location,
#                                     displayName = "test_01_bq")
```

### Import data 

Execute import from BigQuery: 

```{r}
# set url as seperate parameter to keep line length under 80
# bq_url <- "bq://gc-automl-tables-r.gcatr_dev.bank_marketing"
# 
# gcat_import_data(projectId = projectId,
#                  location = location,
#                  dataset_display_name = "test_01_bq",
#                  input_source = "bq",
#                  input_url = bq_url)
```


## View dataset 

Once the import - from GCS or BQ - is completed, you'll recieve an email notification. Locate the `datasetId` in the GCP console or via `gcat_list_datasets` function. (e.g. - will be in the form `TBL123456789`) Once the data import is completed, we can then sanity check the results.

First, let's set our `dataset_display_name` and `datasetId` in advance for cleaner code later:

```{r}
dataset_display_name <- "test_01_bq"
```

Now we're ready to view the results and get the `tableSpecId` we need for later functions:

```{r}
dataset <- gcat_get_dataset(projectId = projectId,
                            locationId = location,
                            displayName = dataset_display_name)
dataset
```

# Updating dataset in AutoML Tables

AutoML Tables automatically detects your data column type. Depending on the type of your label column, AutoML Tables chooses to run a classification or regression model. If your label column contains only numerical values, but they represent categories, change your label column type to categorical by updating your schema.

Lets first view the table schema and the columns

## Get table specifications (tableSpec)

```{r}
table_spec <- gcat_get_table_specs(projectId = projectId,
                                   locationId = location,
                                   displayName = dataset_display_name)
table_spec
```

## List column specs 

```{r}
column_specs_list <- gcat_list_column_specs(projectId = projectId,
                                            locationId = location,
                                            displayName = dataset_display_name)
column_specs_list
```
## Visualize column specs 

TODO - @justinm - add visualization of column specs? 

### Get info about our target column 

```{r}
column_spec <- gcat_get_column_specs(projectId = projectId,
                                     locationId = location,
                                     displayName = dataset_display_name,
                                     columnDisplayName = "V16")
column_spec 
```

## Set label or target column 

Set V16 or outcome [source](https://datahub.io/machine-learning/bank-marketing) as label

```{r}
# TODO @justinjm - change to "set_target" to align with python sdk?
dataset <- gcat_set_label(projectId = projectId,
                          locationId = location,
                          displayName = dataset_display_name,
                          labelColumnDisplayName = "V16")
dataset
```

## Modeling 

### Create model 

Training or creating a model is done with `gcat_create_model`.

This will be a long-lasting operation. You will recieve an email when the model training completes

```{r}
# gcat_model_01 <- gcat_create_model(
#   projectId = projectId,
#   locationId = location,
#   datasetDisplayName = "test_01_bq",
#   columnDisplayName = "V16",
#   modelDisplayName = "test_01_bq_01",
#   optimizationObjective = "MINIMIZE_LOG_LOSS",
#   trainBudgetMilliNodeHours = 1000)

# gcat_model_01
```

More details here: [Training models|AutoML Tables Documentation](https://cloud.google.com/automl-tables/docs/train)

### Viewing Models
While you wait - or after your latest model training completes - you can view the list trained models: 

```{r}
models_list <- gcat_list_models(projectId = projectId,
                                locationId = location)
models_list
```

After the model has trained, you can get the trainied model with the following:

```{r}
gcat_model <- gcat_get_model(projectId = projectId,
                             locationId = location,
                             modelDisplayName = "test_01_bq_01")
gcat_model
```


### Evalute the model 

After training has been completed, you can review various performance statistics on the model, such as the accuracy, precision, recall, and so on. The metrics are returned in a nested data structure:

```{r}
# model_evaluation <- gcat_list_model_evaluations(
#   projectId = projectId,
#   locationId = location,
#   modelDisplayName = "test_01_bq_01"
# )
```


```{r VIEW-DEBUG}
# view debugging info
# readRDS("request_debug.rds")
```


### Make batch prediction 

### Evaluate predictions 
